name: Scheduled E2E Tests

on:
  schedule:
    # Run every day at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit

env:
  E2E_BASE_URL: https://ownly-kit.vercel.app

jobs:
  e2e-scheduled:
    name: Scheduled E2E (${{ matrix.browser }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps ${{ matrix.browser }}
      
      - name: Run Playwright Tests
        run: pnpm exec playwright test --project=${{ matrix.browser }}
        env:
          E2E_BASE_URL: ${{ env.E2E_BASE_URL }}
      
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}-${{ github.run_number }}
          path: playwright-report/
          retention-days: 14

  url-health-check:
    name: URL Health Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      
      - name: Run URL Health Tests
        run: pnpm test:urls
        env:
          E2E_BASE_URL: ${{ env.E2E_BASE_URL }}

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [e2e-scheduled, url-health-check]
    if: failure()
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Scheduled E2E Tests Failed - ${new Date().toISOString().split('T')[0]}`
            const body = `
            ## Scheduled E2E Test Failure
            
            **Run:** [${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Date:** ${new Date().toISOString()}
            
            Please investigate the failing tests and fix any issues.
            
            ### Quick Links
            - [View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - [Live Site](https://ownly-kit.vercel.app)
            `
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'e2e-failure', 'automated']
            })
